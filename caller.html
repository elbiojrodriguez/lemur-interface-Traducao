<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Projeto Câmeras Cruzadas</title>
  <style>
    body {
      margin: 0;
      background-color: #000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    #boxVerde {
      width: 200px;
      height: 120px;
      border: 3px solid limegreen;
      background-color: black;
    }
    #qrcode {
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <video id="boxVerde" autoplay playsinline muted></video>
  <canvas id="qrcode"></canvas>

  <script>
    const boxVerde = document.getElementById('boxVerde');
    const qrCanvas = document.getElementById('qrcode');
    let localStream;
    const myId = crypto.randomUUID().substr(0, 8);
    const userLang = navigator.language || 'unknown';

    // Autorização imediata
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        localStream = stream;

        const urlParams = new URLSearchParams(window.location.search);
        const targetId = urlParams.get('targetId');

        if (targetId) {
          rtcCore.startCall(targetId, localStream);
        } else {
          const fullUrl = `${window.location.origin}${window.location.pathname}?targetId=${myId}&lang=${encodeURIComponent(userLang)}`;
          generateQRCode(fullUrl);
        }
      })
      .catch(error => {
        console.error('Erro ao acessar câmera/microfone:', error);
      });

    // Gera QR Code simples usando canvas
    function generateQRCode(text) {
      const canvas = qrCanvas;
      const size = 150;
      canvas.width = size;
      canvas.height = size;

      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#fff';
      ctx.fillRect(0, 0, size, size);

      // QR Code básico (substitua por lib se quiser mais qualidade)
      // Aqui usamos uma simplificação para manter tudo interno
      // Para produção, recomendo usar uma lib como QRCode.js

      // Simulação: desenha texto como QR (não é real QR)
      ctx.fillStyle = '#000';
      ctx.font = '10px monospace';
      ctx.fillText(text, 10, 75);
    }

    // Coração do WebRTC
    const rtcCore = {
      peerConnection: null,

      startCall: function(targetId, stream) {
        this.peerConnection = new RTCPeerConnection();

        stream.getTracks().forEach(track => {
          this.peerConnection.addTrack(track, stream);
        });

        this.peerConnection.ontrack = event => {
          boxVerde.srcObject = event.streams[0];
        };

        this.peerConnection.createOffer()
          .then(offer => this.peerConnection.setLocalDescription(offer))
          .then(() => {
            // Enviar offer via sinalização
            // sinalizacao.send(targetId, this.peerConnection.localDescription);
          });
      },

      receiveAnswer: function(answer) {
        this.peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
      },

      receiveOffer: function(offer, stream) {
        this.peerConnection = new RTCPeerConnection();

        stream.getTracks().forEach(track => {
          this.peerConnection.addTrack(track, stream);
        });

        this.peerConnection.ontrack = event => {
          boxVerde.srcObject = event.streams[0];
        };

        this.peerConnection.setRemoteDescription(new RTCSessionDescription(offer))
          .then(() => this.peerConnection.createAnswer())
          .then(answer => this.peerConnection.setLocalDescription(answer))
          .then(() => {
            // Enviar resposta via sinalização
            // sinalizacao.send(offer.senderId, this.peerConnection.localDescription);
          });
      }
    };
  </script>
</body>
</html>
