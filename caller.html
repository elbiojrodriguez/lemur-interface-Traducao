<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lemur Tradutor - Mobile</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        body {
            background: linear-gradient(135deg, #128C7E 0%, #075E54 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .subtitle {
            text-align: center;
            margin-bottom: 25px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 16px;
        }
        
        .translation-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .translation-section h2 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 20px;
            color: #25D366;
        }
        
        .translation-box {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .text-display {
            background: white;
            border-radius: 10px;
            padding: 15px;
            min-height: 120px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .text-display h3 {
            color: #075E54;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .text-content {
            color: #333;
            font-size: 16px;
            line-height: 1.5;
            min-height: 70px;
        }
        
        .speaker-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #075E54;
            padding: 5px;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .speaker-btn:hover {
            background-color: rgba(7, 94, 84, 0.1);
        }
        
        .speaker-btn.active {
            color: #25D366;
            background-color: rgba(37, 211, 102, 0.1);
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .record-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #25D366;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            border: none;
            color: white;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .record-btn.recording {
            background: #e74c3c;
            animation: pulse 1.5s infinite;
        }
        
        .btn-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            text-align: center;
        }
        
        /* Modal de grava√ß√£o estilo WhatsApp */
        .recording-modal {
            position: fixed;
            bottom: -100%;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: bottom 0.5s ease;
            z-index: 1000;
        }
        
        .recording-modal.visible {
            bottom: 100px;
        }
        
        .recording-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            width: 100%;
        }
        
        .recording-dot {
            width: 12px;
            height: 12px;
            background: #e74c3c;
            border-radius: 50%;
            margin-right: 10px;
            animation: blink 1s infinite;
        }
        
        .recording-text {
            color: white;
            font-size: 16px;
        }
        
        .recording-timer {
            color: white;
            font-size: 14px;
            margin-left: auto;
        }
        
        .send-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #25D366;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }
        
        /* Anima√ß√µes */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        
        .api-status {
            text-align: center;
            margin-top: 15px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* Responsividade para mobile */
        @media (max-width: 600px) {
            .container {
                padding: 15px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .text-display {
                min-height: 100px;
                padding: 12px;
            }
            
            .translation-section {
                padding: 15px;
            }
            
            .record-btn {
                width: 70px;
                height: 70px;
            }
            
            .recording-modal {
                width: 90%;
                max-width: 300px;
            }
        }
        
        .permission-request {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .permission-btn {
            background: #25D366;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            margin-top: 10px;
            cursor: pointer;
        }
        
        .stop-speech-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            margin-top: 10px;
            cursor: pointer;
            font-size: 12px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Lemur Tradutor</h1>
        </div>
        
        <p class="subtitle">Traduza do Portugu√™s para o Ingl√™s em tempo real</p>
        
        <div class="translation-section">
            <h2>Tradu√ß√£o por Voz</h2>
            
            <div id="permissionRequest" class="permission-request">
                <p>Para usar o tradutor de voz, precisamos da permiss√£o do microfone.</p>
                <button class="permission-btn" id="permissionButton">Conceder permiss√£o</button>
            </div>
            
            <div class="translation-box">
                <div class="text-display">
                    <h3>Texto em Portugu√™s</h3>
                    <div id="originalText" class="text-content">Aguardando permiss√£o do microfone...</div>
                </div>
                
                <div class="text-display">
                    <h3>
                        Tradu√ß√£o em Ingl√™s 
                        <button class="speaker-btn" id="speakerButton" title="Ouvir tradu√ß√£o" disabled>üîä</button>
                    </h3>
                    <div id="translatedText" class="text-content">A tradu√ß√£o aparecer√° aqui</div>
                    <button class="stop-speech-btn" id="stopSpeechButton">Parar √°udio</button>
                </div>
            </div>
            
            <div class="controls">
                <button class="record-btn" id="recordButton" disabled>üé§</button>
                <p class="btn-label" id="instructionText">Toque e segure para falar, ou toque uma vez para gravar e toque novamente para parar</p>
            </div>
            
            <div class="api-status" id="apiStatus">
                Conectando com a API de tradu√ß√£o...
            </div>
        </div>
    </div>
    
    <!-- Modal de grava√ß√£o estilo WhatsApp -->
    <div class="recording-modal" id="recordingModal">
        <div class="recording-indicator">
            <div class="recording-dot"></div>
            <div class="recording-text">Gravando</div>
            <div class="recording-timer" id="recordingTimer">0:00</div>
        </div>
        <button class="send-button" id="sendButton">‚ñ∂</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos DOM
            const recordButton = document.getElementById('recordButton');
            const instructionText = document.getElementById('instructionText');
            const originalText = document.getElementById('originalText');
            const translatedText = document.getElementById('translatedText');
            const recordingModal = document.getElementById('recordingModal');
            const recordingTimer = document.getElementById('recordingTimer');
            const sendButton = document.getElementById('sendButton');
            const apiStatus = document.getElementById('apiStatus');
            const permissionRequest = document.getElementById('permissionRequest');
            const permissionButton = document.getElementById('permissionButton');
            const speakerButton = document.getElementById('speakerButton');
            const stopSpeechButton = document.getElementById('stopSpeechButton');
            
            // ENDPOINT da API de tradu√ß√£o
            const TRANSLATE_ENDPOINT = 'https://chat-tradutor.onrender.com/translate';
            
            // Verificar se o navegador suporta reconhecimento de voz e s√≠ntese de voz
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const SpeechSynthesis = window.speechSynthesis;
            
            if (!SpeechRecognition) {
                originalText.textContent = "Seu navegador n√£o suporta reconhecimento de voz. Tente usar Chrome ou Edge.";
                recordButton.style.display = 'none';
                apiStatus.textContent = "Navegador n√£o compat√≠vel com reconhecimento de voz";
                permissionRequest.style.display = 'none';
                return;
            }
            
            if (!SpeechSynthesis) {
                speakerButton.style.display = 'none';
                apiStatus.textContent += " | Navegador n√£o compat√≠vel com leitura de texto";
            }
            
            const recognition = new SpeechRecognition();
            recognition.lang = 'pt-BR';
            recognition.continuous = true;
            recognition.interimResults = true;
            
            // Vari√°veis de estado
            let isRecording = false;
            let recordingStartTime = 0;
            let timerInterval = null;
            let pressTimer;
            let microphonePermissionGranted = false;
            let tapMode = false; // false = modo pressionar, true = modo toque
            let isSpeechPlaying = false;
            
            // Solicitar permiss√£o do microfone
            permissionButton.addEventListener('click', requestMicrophonePermission);
            
            // Eventos para o bot√£o de √°udio
            speakerButton.addEventListener('click', toggleSpeech);
            stopSpeechButton.addEventListener('click', stopSpeech);
            
            async function requestMicrophonePermission() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    // Parar as tracks imediatamente ap√≥s obter a permiss√£o
                    stream.getTracks().forEach(track => track.stop());
                    
                    microphonePermissionGranted = true;
                    permissionRequest.style.display = 'none';
                    recordButton.disabled = false;
                    originalText.textContent = "Toque e segure o bot√£o para falar";
                    apiStatus.textContent = "Permiss√£o concedida. Conectando com a API...";
                    
                    // Testar a conex√£o com a API
                    testApiConnection();
                } catch (error) {
                    console.error('Erro ao acessar o microfone:', error);
                    permissionRequest.innerHTML = `
                        <p>Permiss√£o do microfone negada. Por favor, permita o acesso ao microfone nas configura√ß√µes do seu navegador.</p>
                        <button class="permission-btn" onclick="window.location.reload()">Tentar novamente</button>
                    `;
                }
            }
            
            // Fun√ß√£o de tradu√ß√£o usando sua API
            async function translateText(text, targetLang = 'en') {
                try {
                    apiStatus.textContent = "Traduzindo...";
                    const response = await fetch(TRANSLATE_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text, targetLang })
                    });

                    const result = await response.json();
                    apiStatus.textContent = "Tradu√ß√£o conclu√≠da com sucesso";
                    
                    // Habilitar o bot√£o de √°udio ap√≥s a tradu√ß√£o
                    if (SpeechSynthesis) {
                        speakerButton.disabled = false;
                    }
                    
                    return result.translatedText || text;
                } catch (error) {
                    console.error('Erro na tradu√ß√£o:', error);
                    apiStatus.textContent = "Erro na tradu√ß√£o. Verifique o console para detalhes.";
                    return "Erro na tradu√ß√£o. Verifique o console para detalhes.";
                }
            }
            
            // Fun√ß√£o para ler o texto em voz alta
            function speakText(text) {
                if (!SpeechSynthesis) return;
                
                // Parar qualquer fala anterior
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US'; // Ingl√™s
                utterance.rate = 0.9; // Velocidade um pouco mais lenta
                
                utterance.onstart = function() {
                    isSpeechPlaying = true;
                    speakerButton.classList.add('active');
                    speakerButton.textContent = 'üîä';
                    stopSpeechButton.style.display = 'block';
                };
                
                utterance.onend = function() {
                    isSpeechPlaying = false;
                    speakerButton.classList.remove('active');
                    stopSpeechButton.style.display = 'none';
                };
                
                utterance.onerror = function() {
                    isSpeechPlaying = false;
                    speakerButton.classList.remove('active');
                    stopSpeechButton.style.display = 'none';
                    apiStatus.textContent = "Erro na reprodu√ß√£o de √°udio";
                };
                
                window.speechSynthesis.speak(utterance);
            }
            
            // Fun√ß√£o para parar a fala
            function stopSpeech() {
                if (SpeechSynthesis) {
                    window.speechSynthesis.cancel();
                    isSpeechPlaying = false;
                    speakerButton.classList.remove('active');
                    stopSpeechButton.style.display = 'none';
                }
            }
            
            // Alternar entre reproduzir e parar a fala
            function toggleSpeech() {
                if (!SpeechSynthesis) return;
                
                if (isSpeechPlaying) {
                    stopSpeech();
                } else {
                    const textToSpeak = translatedText.textContent;
                    if (textToSpeak && textToSpeak !== "A tradu√ß√£o aparecer√° aqui" && 
                        textToSpeak !== "Traduzindo..." && !textToSpeak.startsWith("Erro")) {
                        speakText(textToSpeak);
                    }
                }
            }
            
            // Testar conex√£o com a API
            async function testApiConnection() {
                try {
                    apiStatus.textContent = "Testando conex√£o com a API...";
                    const response = await fetch(TRANSLATE_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: "teste", targetLang: 'en' })
                    });
                    
                    if (response.ok) {
                        apiStatus.textContent = "Conectado √† API de tradu√ß√£o";
                    } else {
                        apiStatus.textContent = "Erro na conex√£o com a API";
                    }
                } catch (error) {
                    console.error('Erro ao conectar com a API:', error);
                    apiStatus.textContent = "Erro ao conectar com a API";
                }
            }
            
            // Eventos de toque para o bot√£o de grava√ß√£o
            recordButton.addEventListener('touchstart', function(e) {
                e.preventDefault();
                if (!microphonePermissionGranted) return;
                
                // Se n√£o est√° gravando, inicia a grava√ß√£o ap√≥s um breve delay
                if (!isRecording) {
                    pressTimer = setTimeout(function() {
                        tapMode = false; // Modo pressionar
                        startRecording();
                    }, 300);
                }
            });
            
            recordButton.addEventListener('touchend', function(e) {
                e.preventDefault();
                clearTimeout(pressTimer);
                
                if (isRecording) {
                    if (tapMode) {
                        // No modo toque, um segundo toque para a grava√ß√£o
                        stopRecording();
                    } else {
                        // No modo pressionar, soltar o bot√£o para a grava√ß√£o
                        stopRecording();
                    }
                } else {
                    // Toque r√°pido - ativa o modo toque
                    tapMode = true;
                    startRecording();
                    showRecordingModal();
                }
            });
            
            // Evento para o bot√£o de enviar no modal
            sendButton.addEventListener('click', stopRecording);
            
            // Prevenir scroll durante o toque no bot√£o
            recordButton.addEventListener('touchstart', function(e) {
                e.preventDefault();
            }, { passive: false });
            
            function startRecording() {
                try {
                    recognition.start();
                    isRecording = true;
                    recordButton.classList.add('recording');
                    recordingStartTime = Date.now();
                    
                    // Iniciar temporizador
                    updateTimer();
                    timerInterval = setInterval(updateTimer, 1000);
                    
                    originalText.textContent = "Ouvindo...";
                    translatedText.textContent = "Aguardando para traduzir...";
                    
                    // Desabilitar o bot√£o de √°udio durante a grava√ß√£o
                    speakerButton.disabled = true;
                } catch (error) {
                    console.error('Erro ao iniciar grava√ß√£o:', error);
                    originalText.textContent = "Erro ao acessar o microfone";
                }
            }
            
            function stopRecording() {
                if (!isRecording) return;
                
                recognition.stop();
                isRecording = false;
                recordButton.classList.remove('recording');
                clearInterval(timerInterval);
                
                // Esconder modal se estiver vis√≠vel
                hideRecordingModal();
            }
            
            recognition.onresult = function(event) {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    }
                }
                
                if (finalTranscript) {
                    originalText.textContent = finalTranscript;
                    translatedText.textContent = "Traduzindo...";
                    
                    // Usar sua API para traduzir o texto
                    translateText(finalTranscript, 'en').then(translation => {
                        translatedText.textContent = translation;
                        
                        // Reproduzir automaticamente a tradu√ß√£o em voz alta
                        if (SpeechSynthesis && translation && !translation.startsWith("Erro")) {
                            setTimeout(() => {
                                speakText(translation);
                            }, 500);
                        }
                    });
                }
            };
            
            recognition.onerror = function(event) {
                console.error('Erro no reconhecimento de voz:', event.error);
                
                // Se for erro de "no-speech", apenas ignore
                if (event.error !== 'no-speech') {
                    originalText.textContent = "Erro: " + event.error;
                }
                
                stopRecording();
            };
            
            recognition.onend = function() {
                stopRecording();
            };
            
            function showRecordingModal() {
                recordingModal.classList.add('visible');
            }
            
            function hideRecordingModal() {
                recordingModal.classList.remove('visible');
            }
            
            function updateTimer() {
                const elapsedSeconds = Math.floor((Date.now() - recordingStartTime) / 1000);
                const minutes = Math.floor(elapsedSeconds / 60);
                const seconds = elapsedSeconds % 60;
                recordingTimer.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
            
            // Verificar se j√° temos permiss√£o do microfone
            navigator.mediaDevices.enumerateDevices()
                .then(devices => {
                    const hasMicrophone = devices.some(device => device.kind === 'audioinput' && device.label !== '');
                    if (hasMicrophone) {
                        microphonePermissionGranted = true;
                        permissionRequest.style.display = 'none';
                        recordButton.disabled = false;
                        originalText.textContent = "Toque e segure o bot√£o para falar";
                        testApiConnection();
                    }
                })
                .catch(err => {
                    console.error('Erro ao verificar dispositivos:', err);
                });
        });
    </script>
</body>
</html>
