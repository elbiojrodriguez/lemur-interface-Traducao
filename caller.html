<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>htmlB - Receptor de A / Ativo B</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; background-color: #f0f0f0; }
    .box { margin-top: 1rem; padding: 1rem; border: 1px solid #ccc; background-color: #fff; }
    button, select { font-size: 1rem; padding: 0.5rem 1rem; margin: 0.5rem 0; }
  </style>
</head>
<body>
  <h2>🔴 Recepção de A</h2>
  <div class="box" id="receivedFromA">Aguardando...</div>

  <h2>🟢 Ativo B</h2>
  <button id="startBtn">🎙️ Iniciar Gravação</button>
  <select id="targetLanguageSelect">
    <option value="en">Inglês</option>
    <option value="es">Espanhol</option>
    <option value="fr">Francês</option>
    <option value="de">Alemão</option>
    <option value="pt">Português</option>
  </select>
  <div class="box" id="originalText"></div>
  <div class="box" id="translatedText"></div>

  <script>
    const startBtn = document.getElementById('startBtn');
    const targetLanguageSelect = document.getElementById('targetLanguageSelect');
    const originalTextDiv = document.getElementById('originalText');
    const translatedTextDiv = document.getElementById('translatedText');
    const receivedFromA = document.getElementById('receivedFromA');

    let socket;
    let mediaRecorder;
    let isRecording = false;

    startBtn.onclick = async () => {
      if (isRecording) {
        mediaRecorder.stop();
        socket.close();
        isRecording = false;
        startBtn.textContent = '🎙️ Iniciar Gravação';
        return;
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        socket = new WebSocket('ws://localhost:8080');

        socket.onopen = () => {
          socket.send(JSON.stringify({
            target: targetLanguageSelect.value,
            clientType: 'B'
          }));

          mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
          mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0 && socket.readyState === WebSocket.OPEN) {
              socket.send(event.data);
            }
          };

          mediaRecorder.start(250);
          isRecording = true;
          startBtn.textContent = '⏹️ Parar Gravação';
        };

        socket.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data.from === 'A') {
            receivedFromA.innerText += data.translated + '\n';
          } else {
            if (data.original) originalTextDiv.innerText += data.original + '\n';
            if (data.translated) translatedTextDiv.innerText += data.translated + '\n';
          }
        };
      } catch (err) {
        console.error('Erro:', err);
      }
    };
  </script>
</body>
</html>
