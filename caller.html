<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Projeto Câmeras Cruzadas</title>
  <style>
    body {
      margin: 0;
      background-color: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    #boxVerde {
      width: 200px;
      height: 120px;
      border: 3px solid limegreen;
      background-color: black;
    }
  </style>
</head>
<body>

  <!-- Vídeo que mostra a câmera do outro celular -->
  <video id="boxVerde" autoplay playsinline muted></video>

  <script>
    const boxVerde = document.getElementById('boxVerde');
    let localStream;

    // Autorização imediata para câmera e microfone
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        localStream = stream;

        // NÃO mostramos a própria câmera localmente
        // Apenas armazenamos para enviar ao outro celular

        // Se houver targetId na URL, inicia chamada
        const urlParams = new URLSearchParams(window.location.search);
        const targetId = urlParams.get('targetId');
        if (targetId) {
          rtcCore.startCall(targetId, localStream);
        }
      })
      .catch(error => {
        console.error('Erro ao acessar câmera/microfone:', error);
      });

    // Coração do WebRTC
    const rtcCore = {
      peerConnection: null,

      startCall: function(targetId, stream) {
        this.peerConnection = new RTCPeerConnection();

        // Adiciona as trilhas de vídeo e áudio
        stream.getTracks().forEach(track => {
          this.peerConnection.addTrack(track, stream);
        });

        // Quando receber vídeo do outro celular, exibe no Box Verde
        this.peerConnection.ontrack = event => {
          boxVerde.srcObject = event.streams[0];
        };

        // Aqui você precisa integrar com seu sistema de sinalização
        // (ex: WebSocket, Firebase, etc.) para trocar ofertas e respostas
        // Este trecho é simbólico e precisa ser adaptado ao seu backend
        this.peerConnection.createOffer()
          .then(offer => {
            return this.peerConnection.setLocalDescription(offer);
          })
          .then(() => {
            // Enviar offer para o targetId via sinalização
            // sinalizacao.send(targetId, this.peerConnection.localDescription);
          });
      },

      // Método para receber resposta do outro celular
      receiveAnswer: function(answer) {
        this.peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
      },

      // Método para receber oferta do outro celular
      receiveOffer: function(offer, stream) {
        this.peerConnection = new RTCPeerConnection();

        stream.getTracks().forEach(track => {
          this.peerConnection.addTrack(track, stream);
        });

        this.peerConnection.ontrack = event => {
          boxVerde.srcObject = event.streams[0];
        };

        this.peerConnection.setRemoteDescription(new RTCSessionDescription(offer))
          .then(() => {
            return this.peerConnection.createAnswer();
          })
          .then(answer => {
            return this.peerConnection.setLocalDescription(answer);
          })
          .then(() => {
            // Enviar resposta de volta via sinalização
            // sinalizacao.send(offer.senderId, this.peerConnection.localDescription);
          });
      }
    };
  </script>
</body>
</html>
