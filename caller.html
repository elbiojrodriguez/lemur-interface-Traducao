<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lemur-EchoMeP2P - Caller</title>
  <style>
    /* ESTILOS (mantidos iguais) */
  </style>
</head>
<body>
  <!-- ESTRUTURA HTML (mantida igual) -->
  
  <!-- Scripts -->
  <script src="https://lemur-signal.onrender.com/socket.io/socket.io.js"></script>
  <script type="module">
    // 📦 Importa o núcleo WebRTC
    import WebRTCCore from '../core/webrtc-core.js';

    // ===== CONFIGURAÇÃO DO TRADUTOR =====
    let IDIOMA_ORIGEM = 'pt-BR';
    const IDIOMA_DESTINO = 'en';
    const IDIOMA_FALA = 'en-US';
    
    const BANDEIRAS_IDIOMAS = {
        'pt-BR': '🇧🇷', 'en': '🇺🇸', 'es': '🇪🇸', 'fr': '🇫🇷', 
        'de': '🇩🇪', 'it': '🇮🇹', 'ja': '🇯🇵'
    };
    
    // ===== ELEMENTOS DOM =====
    const recordButton = document.getElementById('recordButton');
    const translatedText = document.getElementById('translatedText');
    const recordingModal = document.getElementById('recordingModal');
    const recordingTimer = document.getElementById('recordingTimer');
    const sendButton = document.getElementById('sendButton');
    const speakerButton = document.getElementById('speakerButton');
    const currentLanguageFlag = document.getElementById('currentLanguageFlag');
    const worldButton = document.getElementById('worldButton');
    const languageDropdown = document.getElementById('languageDropdown');
    const languageOptions = document.querySelectorAll('.language-option');
    const callActionBtn = document.getElementById('callActionBtn');
    
    // ===== CONFIGURAÇÃO INICIAL =====
    currentLanguageFlag.textContent = BANDEIRAS_IDIOMAS[IDIOMA_ORIGEM];
    translatedText.textContent = "🎤";
    
    // ===== VERIFICAÇÃO DE SUPORTE =====
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const SpeechSynthesis = window.speechSynthesis;
    
    if (!SpeechRecognition) {
        translatedText.textContent = "❌ Navegador não suportado";
        recordButton.style.display = 'none';
    }
    
    if (!SpeechSynthesis) {
        speakerButton.style.display = 'none';
    }
    
    let recognition;
    let isRecording = false;
    let recordingStartTime = 0;
    let timerInterval = null;
    let microphonePermissionGranted = false;
    let isSpeechPlaying = false;
    
    // ===== INICIALIZAÇÃO DO RECOGNITION =====
    function initializeRecognition() {
        if (recognition) {
            recognition.stop();
        }
        
        recognition = new SpeechRecognition();
        recognition.lang = IDIOMA_ORIGEM;
        recognition.continuous = true;
        recognition.interimResults = true;
        
        recognition.onresult = function(event) {
            let finalTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript;
                }
            }
            
            if (finalTranscript) {
                translatedText.textContent = "⏳ Traduzindo...";
                translateText(finalTranscript).then(translation => {
                    translatedText.textContent = translation;
                    if (SpeechSynthesis) {
                        setTimeout(() => speakText(translation), 500);
                    }
                });
            }
        };
        
        recognition.onerror = function(event) {
            console.error('Erro recognition:', event.error);
            if (event.error !== 'no-speech') {
                translatedText.textContent = "❌ Erro de gravação";
            }
            stopRecording();
        };
        
        recognition.onend = function() {
            if (isRecording) {
                stopRecording();
            }
        };
    }
    
    // ===== FUNÇÕES DE IDIOMA =====
    worldButton.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        languageDropdown.classList.toggle('show');
    });
    
    document.addEventListener('click', function(e) {
        if (!languageDropdown.contains(e.target) && e.target !== worldButton) {
            languageDropdown.classList.remove('show');
        }
    });
    
    languageOptions.forEach(option => {
        option.addEventListener('click', function() {
            const novoIdioma = this.getAttribute('data-lang');
            IDIOMA_ORIGEM = novoIdioma;
            currentLanguageFlag.textContent = BANDEIRAS_IDIOMAS[novoIdioma];
            languageDropdown.classList.remove('show');
            
            if (isRecording) {
                recognition.stop();
            }
            
            initializeRecognition();
            
            translatedText.textContent = "✅";
            setTimeout(() => translatedText.textContent = "🎤", 1000);
        });
    });
    
    async function requestMicrophonePermission() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            stream.getTracks().forEach(track => track.stop());
            microphonePermissionGranted = true;
            recordButton.disabled = false;
            translatedText.textContent = "🎤 Toque para falar";
            initializeRecognition();
        } catch (error) {
            console.error('Erro permissão microfone:', error);
            translatedText.textContent = "🚫 Microfone não acessível";
            recordButton.disabled = true;
        }
    }
    
    async function translateText(text) {
        try {
            console.log('Enviando para tradução:', text);
            const response = await fetch('https://chat-tradutor.onrender.com/translate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text, targetLang: IDIOMA_DESTINO })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            console.log('Tradução recebida:', result);
            speakerButton.disabled = false;
            return result.translatedText || "❌ Erro na tradução";
        } catch (error) {
            console.error('Erro na tradução:', error);
            return "❌ Erro de conexão";
        }
    }
    
    function speakText(text) {
        if (!SpeechSynthesis) return;
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = IDIOMA_FALA;
        utterance.rate = 0.9;
        utterance.onstart = function() {
            isSpeechPlaying = true;
            speakerButton.textContent = '⏹';
        };
        utterance.onend = function() {
            isSpeechPlaying = false;
            speakerButton.textContent = '🔊';
        };
        window.speechSynthesis.speak(utterance);
    }
    
    function toggleSpeech() {
        if (!SpeechSynthesis) return;
        if (isSpeechPlaying) {
            window.speechSynthesis.cancel();
            isSpeechPlaying = false;
            speakerButton.textContent = '🔊';
        } else {
            const textToSpeak = translatedText.textContent;
            if (textToSpeak && textToSpeak !== "🎤" && textToSpeak !== "⏳" && !textToSpeak.includes("❌")) {
                speakText(textToSpeak);
            }
        }
    }
    
    function startRecording() {
        try {
            recognition.start();
            isRecording = true;
            recordButton.classList.add('recording');
            recordingStartTime = Date.now();
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
            translatedText.textContent = "🎙️ Gravando...";
            speakerButton.disabled = true;
            speakerButton.textContent = '🔇';
        } catch (error) {
            console.error('Erro ao iniciar gravação:', error);
            translatedText.textContent = "❌ Erro ao iniciar gravação";
        }
    }
    
    function stopRecording() {
        if (!isRecording) return;
        isRecording = false;
        recordButton.classList.remove('recording');
        clearInterval(timerInterval);
        hideRecordingModal();
        translatedText.textContent = "⏳ Processando...";
        
        try {
            recognition.stop();
        } catch (error) {
            console.error('Erro ao parar recognition:', error);
        }
    }
    
    function showRecordingModal() {
        recordingModal.classList.add('visible');
    }
    
    function hideRecordingModal() {
        recordingModal.classList.remove('visible');
    }
    
    function updateTimer() {
        const elapsedSeconds = Math.floor((Date.now() - recordingStartTime) / 1000);
        const minutes = Math.floor(elapsedSeconds / 60);
        const seconds = elapsedSeconds % 60;
        recordingTimer.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // ===== EVENTOS DO TRADUTOR =====
    recordButton.addEventListener('click', function(e) {
        e.preventDefault();
        if (recordButton.disabled || !microphonePermissionGranted) return;
        
        if (!isRecording) {
            startRecording();
            showRecordingModal();
        } else {
            stopRecording();
        }
    });
    
    sendButton.addEventListener('click', stopRecording);
    speakerButton.addEventListener('click', toggleSpeech);
    
    // ===== INICIALIZAÇÃO DO TRADUTOR =====
    if (SpeechRecognition) {
        requestMicrophonePermission();
    }

    // ===== FUNCIONALIDADE DE VIDEOCHAMADA =====
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Solicita acesso à câmera para o caller também
        await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      } catch (error) {
        console.error("Erro ao acessar a câmera:", error);
      }

      const rtcCore = new WebRTCCore();
      const myId = crypto.randomUUID().substr(0, 8);

      // 🔌 Inicializa conexão WebRTC
      rtcCore.initialize(myId);
      rtcCore.setupSocketHandlers();

      // 🎥 Captura vídeo local
      let localStream = null;
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        const localVideo = document.getElementById('localVideo');
        localVideo.srcObject = localStream;
      } catch (error) {
        console.error("Erro ao acessar a câmera:", error);
      }

      // 🔍 Extrai parâmetros do QR Code (receiver)
      const urlParams = new URLSearchParams(window.location.search);
      const receiverId = urlParams.get('targetId') || '';
      const receiverToken = urlParams.get('token') || '';
      const receiverLang = urlParams.get('lang') || 'pt-BR';

      // 📞 Botão de chamada
      if (receiverId) {
        callActionBtn.style.display = 'block';

        callActionBtn.addEventListener('click', () => {
          if (localStream) {
            const callerLang = IDIOMA_ORIGEM;
            console.log('Iniciando chamada para:', receiverId, 'com idioma:', callerLang);
            rtcCore.startCall(receiverId, localStream, callerLang);
          }
        });
      }

      // 📺 Exibe vídeo remoto recebido
      rtcCore.setRemoteStreamCallback(stream => {
        stream.getAudioTracks().forEach(track => track.enabled = false);
        const remoteVideo = document.getElementById('remoteVideo');
        remoteVideo.srcObject = stream;
      });

      // 🏳️ Aplica bandeira do idioma do receiver (remoto)
      async function aplicarBandeiraRemota(langCode) {
        try {
          const response = await fetch('assets/bandeiras/language-flags.json');
          const flags = await response.json();
          const bandeira = flags[langCode] || flags[langCode.split('-')[0]] || '🔴';

          const remoteLangElement = document.querySelector('.remoter-Lang');
          if (remoteLangElement) {
            remoteLangElement.textContent = bandeira;
          }
        } catch (error) {
          console.error('Erro ao carregar bandeira remota:', error);
          const remoteLangElement = document.querySelector('.remoter-Lang');
          if (remoteLangElement) {
            remoteLangElement.textContent = '🔴';
          }
        }
      }

      // 🚩 Aplica bandeiras iniciais
      aplicarBandeiraRemota(receiverLang);
      
      // Aplica bandeira local
      const localLangDisplay = document.querySelector('.local-Lang');
      if (localLangDisplay) {
        localLangDisplay.textContent = BANDEIRAS_IDIOMAS[IDIOMA_ORIGEM];
      }
    });
  </script>
</body>
</html>
