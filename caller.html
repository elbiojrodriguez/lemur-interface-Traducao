<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisualLink - Transmissão Assimétrica</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            background: #f0f0f0;
            position: relative;
        }

        /* Box Verde (exclusivo para vídeo recebido de B) */
        #incomingVisualBox {
            position: absolute;
            bottom: 140px;
            right: 5px;
            width: 34.5%;
            max-width: 138px;
            height: 184px;
            transform: translateX(-17%);
            border: 2px solid #4CAF50;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            z-index: 10;
        }

        #incomingVisualBox video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Área de tradução */
        #translationArea {
            position: absolute;
            bottom: 350px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 200px;
            border: 2px solid #007BFF;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 10px;
            overflow-y: auto;
        }

        /* Overlay de permissão */
        #permissionOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            z-index: 100;
        }

        #permissionOverlay button {
            margin-top: 20px;
            padding: 12px 24px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Box Verde (vídeo de B) -->
    <div id="incomingVisualBox">
        <video id="incomingVideo" autoplay playsinline></video>
    </div>

    <!-- Área de tradução -->
    <div id="translationArea"></div>

    <!-- Overlay inicial -->
    <div id="permissionOverlay">
        <h2>Acesso Necessário</h2>
        <p><strong>Sua câmera será transmitida para o destinatário, mas não aparecerá nesta tela.</strong></p>
        <p>O vídeo recebido será exibido no <span style="color: #4CAF50;">Box Verde</span>.</p>
        <button id="grantPermissionBtn">PERMITIR CÂMERA E MICROFONE</button>
    </div>

    <script>
        // instant-qr-generator.js - Versão Final (modificado para remover o QR após permissão)
        class InstantQRGenerator {
          constructor(options = {}) {
            // Configurações padrão
            this.settings = {
              containerId: 'instant-qr-container',
              qrSize: 200,
              baseUrl: 'https://lemur-interface-traducao.netlify.app/caller.html',
              showInfo: false,
              ...options
            };

            // Cria container imediatamente
            this.createContainer();
            
            // Gera dados dinâmicos
            const { tempId, userLanguage, deviceType } = this.generateDynamicData();
            
            // Carrega biblioteca e gera QR Code
            this.loadQRLibrary().then(() => {
              this.generateQRCode(tempId, userLanguage, deviceType);
              
              // Opcional: exibe informações no console
              if (this.settings.showInfo) {
                console.log('QR Code gerado com:', { 
                  id: tempId, 
                  language: userLanguage, 
                  device: deviceType,
                  url: this.buildUrl(tempId, userLanguage, deviceType)
                });
              }
            });
          }

          createContainer() {
            // Cria container mínimo antes do DOM estar pronto
            if (!document.getElementById(this.settings.containerId)) {
              const container = document.createElement('div');
              container.id = this.settings.containerId;
              container.style.position = 'fixed';
              container.style.top = '0';
              container.style.left = '0';
              container.style.width = '100%';
              container.style.height = '100%';
              container.style.backgroundColor = 'white';
              container.style.display = 'flex';
              container.style.flexDirection = 'column';
              container.style.justifyContent = 'center';
              container.style.alignItems = 'center';
              container.style.zIndex = '9999';
              document.body.prepend(container);
            }
          }

          generateDynamicData() {
            // Gera ID temporário (8 caracteres alfanuméricos)
            const tempId = Math.random().toString(36).substring(2, 10);
            
            // Detecta idioma do navegador (primeiras 2 letras)
            const userLanguage = (navigator.language || 'pt').substring(0, 2);
            
            // Detecta tipo de dispositivo simplificado
            const deviceType = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) ? 'mobile' : 'desktop';
            
            return { tempId, userLanguage, deviceType };
          }

          buildUrl(id, lang, device) {
            return `${this.settings.baseUrl}?id=${encodeURIComponent(id)}&lang=${lang}&device=${device}`;
          }

          loadQRLibrary() {
            return new Promise((resolve, reject) => {
              if (typeof QRCode !== 'undefined') {
                resolve();
                return;
              }

              const script = document.createElement('script');
              script.src = 'https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js';
              script.onload = resolve;
              script.onerror = reject;
              document.head.appendChild(script);
            });
          }

          generateQRCode(id, lang, device) {
            const container = document.getElementById(this.settings.containerId);
            if (!container) return;

            // Limpa container e gera novo QR Code
            container.innerHTML = '';
            new QRCode(container, {
              text: this.buildUrl(id, lang, device),
              width: this.settings.qrSize,
              height: this.settings.qrSize,
              colorDark: "#000000",
              colorLight: "#ffffff",
              correctLevel: QRCode.CorrectLevel.H
            });

            // Adiciona informações abaixo do QR Code (opcional)
            if (this.settings.showInfo) {
              const infoDiv = document.createElement('div');
              infoDiv.style.marginTop = '20px';
              infoDiv.style.fontFamily = 'Arial, sans-serif';
              infoDiv.innerHTML = `
                <p>ID: ${id}</p>
                <p>Idioma: ${lang}</p>
                <p>Dispositivo: ${device}</p>
              `;
              container.appendChild(infoDiv);
            }
          }

          // Novo método para remover o QR Code
          removeQRCode() {
            const container = document.getElementById(this.settings.containerId);
            if (container) {
              container.style.display = 'none';
              // Ou se preferir remover completamente:
              // container.remove();
            }
          }
        }

        // Cria uma instância acessível globalmente
        const qrGenerator = new InstantQRGenerator({
          // showInfo: true // Descomente para mostrar informações abaixo do QR Code
        }); 

        document.addEventListener('DOMContentLoaded', async () => {
            const permissionOverlay = document.getElementById('permissionOverlay');
            const grantPermissionBtn = document.getElementById('grantPermissionBtn');
            const incomingVideo = document.getElementById('incomingVideo');
            const translationArea = document.getElementById('translationArea');

            // 1. Solicita permissões (câmera + microfone)
            grantPermissionBtn.addEventListener('click', async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });

                    permissionOverlay.style.display = 'none';
                    
                    // Remove o QR Code quando as permissões são concedidas
                    qrGenerator.removeQRCode();
                    
                    // 2. Inicia conexão (seu stream é enviado para B)
                    startConnection(stream);

                    // 3. Simula recebimento do vídeo de B (substitua pelo real)
                    incomingVideo.srcObject = await simulateIncomingStream();

                } catch (error) {
                    console.error("Erro:", error);
                    permissionOverlay.innerHTML = `
                        <h2 style="color: #ff4444;">Permissão Negada</h2>
                        <p>O recurso não funciona sem acesso à câmera.</p>
                    `;
                }
            });

            // Funções de exemplo (substitua pela sua lógica real)
            function startConnection(localStream) {
                translationArea.innerHTML = '<p>✔ Conexão estabelecida</p>';
            }

            async function simulateIncomingStream() {
                return await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 }
                });
            }
        });
    </script>
</body>
</html>
