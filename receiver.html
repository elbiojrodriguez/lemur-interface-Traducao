<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoMeP2P - Welcome & Permissions</title>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <style>
        /* [SEUS ESTILOS EXISTENTES AQUI] */
        /* Mantenha todos os estilos anteriores */
    </style>
</head>
<body>
    <!-- [SEU HTML EXISTENTE AQUI] -->
    <!-- Mantenha toda a estrutura HTML anterior -->

    <script>
        // Lê o token da URL (chave do Firebase)
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        
        // Variável para armazenar o ID fixo gerado
        let fixedId = null;
        
        // Exibe o token se estiver presente na URL
        if (token) {
            document.getElementById('token-value').textContent = token;
            document.getElementById('token-container').style.display = 'flex';
            console.log("Token recebido:", token);
            
            // GERA O ID FIXO com os últimos 5 caracteres do token
            fixedId = token.slice(-5);
            console.log("ID Fixo gerado:", fixedId);
            
            // Exibe o ID fixo na tela
            document.getElementById('fixed-id-value').textContent = fixedId;
            document.getElementById('fixed-id-container').style.display = 'flex';
            
            // Ajusta a posição dos outros elementos para acomodar o token e o ID fixo
            document.getElementById('qr-result-container').style.top = '85%';
        } else {
            // Mostra aviso se não houver token
            document.getElementById('warning-message').style.display = 'block';
            document.getElementById('qr-result-container').style.top = '75%';
        }

        // [CÓDIGO DE TRADUÇÃO EXISTENTE AQUI]
        // Mantenha o código de tradução

        // Classe para gerar QR Code
        class QRCodeGenerator {
          static generate(containerId, text, size = 150) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            return new QRCode(container, {
              text: text,
              width: size,
              height: size,
              colorDark: "#000000",
              colorLight: "#ffffff",
            });
          }
        }

        // [FUNÇÕES EXISTENTES DE PERMISSÕES AQUI]
        // Mantenha as funções de requestMediaPermissions

        // Código principal
        document.addEventListener('DOMContentLoaded', async () => {
            const nextButton = document.getElementById('next-button');
            const nameInput = document.getElementById('name-input');
            const welcomeScreen = document.getElementById('welcome-screen');
            const qrResultContainer = document.getElementById('qr-result-container');
            const urlContent = document.getElementById('url-content');
            const loaderContainer = document.getElementById('loader-container');
            const cameraCheckbox = document.getElementById('camera-checkbox');
            const microphoneCheckbox = document.getElementById('microphone-checkbox');
            
            // Elementos da nova tela de QR Code
            const qrScreen = document.getElementById('qr-screen');
            const closeButton = document.getElementById('close-button');
            const urlContentModal = document.getElementById('url-content-modal');
            
            let cameraGranted = false;
            let microphoneGranted = false;

            // [PROCESSO DE TRADUÇÃO EXISTENTE AQUI]
            // Mantenha o código de tradução

            // Event listener para os checkboxes
            cameraCheckbox.addEventListener('click', async () => {
                cameraGranted = await requestMediaPermissions();
                if (cameraGranted) {
                    cameraCheckbox.classList.add('checked');
                } else {
                    cameraCheckbox.classList.remove('checked');
                }
            });

            microphoneCheckbox.addEventListener('click', async () => {
                microphoneGranted = await requestMediaPermissions();
                if (microphoneGranted) {
                    microphoneCheckbox.classList.add('checked');
                } else {
                    microphoneCheckbox.classList.remove('checked');
                }
            });

            // Event listener para o botão Next - MODIFICADO
            nextButton.addEventListener('click', async () => {
                const name = nameInput.value.trim();
                let hasError = false;

                if (!name) {
                    hasError = true;
                }

                if (!cameraGranted || !microphoneGranted) {
                    hasError = true;
                }
                
                // Verifica se há token (chave do Firebase)
                if (!token) {
                    hasError = true;
                    document.getElementById('warning-message').style.display = 'block';
                }

                if (hasError) {
                    welcomeScreen.classList.add('error-state');
                    setTimeout(() => {
                        welcomeScreen.classList.remove('error-state');
                    }, 1000);
                    return;
                }

                // Mostra loader durante geração do QR code
                loaderContainer.style.display = 'flex';

                // Gera o QR CODE com parâmetros bem identificados - MODIFICADO
                const browserFullLang = navigator.language || 'pt-BR';
                const baseUrl = 'https://lemur-interface-traducao.netlify.app/caller.html';
                
                // URL com parâmetros bem identificados (SUGESTÃO)
                const fullUrl = `${baseUrl}?token=${encodeURIComponent(token)}&browserId=${encodeURIComponent(fixedId)}&lang=${encodeURIComponent(browserFullLang)}&name=${encodeURIComponent(name)}`;
                
                // ALTERNATIVA: Mantendo targetId para compatibilidade
                // const fullUrl = `${baseUrl}?token=${encodeURIComponent(token)}&targetId=${encodeURIComponent(fixedId)}&browserId=${encodeURIComponent(fixedId)}&lang=${encodeURIComponent(browserFullLang)}&name=${encodeURIComponent(name)}`;
                
                console.log("QR Code URL:", fullUrl);
                
                // Gera o QR code na nova tela
                setTimeout(() => {
                    QRCodeGenerator.generate("qrcode-modal", fullUrl, 200);
                    urlContentModal.textContent = fullUrl;
                    qrScreen.style.display = 'flex';
                    loaderContainer.style.display = 'none';
                }, 500);
            });

            // Fechar a tela de QR Code
            closeButton.addEventListener('click', () => {
                qrScreen.style.display = 'none';
            });

            // Fechar a tela de QR Code ao clicar fora do conteúdo
            qrScreen.addEventListener('click', (e) => {
                if (e.target === qrScreen) {
                    qrScreen.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
