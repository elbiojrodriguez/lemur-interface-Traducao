<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Receiver - Videochamada Mobile</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="responsivo.css" />
  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
  <style>
    /* üîµ ESTILO DO BOX AZUL (ID√äNTICO AO CALLER) */
    .chat-input-box {
        position: absolute;
        bottom: 350px;
        left: 50%;
        transform: translateX(-50%);
        width: 80%;
        height: 200px;
        border: 2px solid #007BFF;
        border-radius: 12px;
        background-color: rgba(255, 255, 255, 0.1);
        z-index: 20;
        overflow-y: auto;
        padding: 10px;
    }

    /* üí¨ ESTILO BASE PARA MENSAGENS */
    .phrase-box {
        background-color: transparent;
        padding: 1px 0;
        margin: 0.5px 0;
        border-radius: 0;
        font-size: 15px;
        line-height: 1.0;
        border: none;
        box-shadow: none;
        width: 100%;
        word-break: break-word;
    }

    /* üéØ TEXTO TEMPOR√ÅRIO */
    .phrase-box.interim-box {
        animation: fadeIn 0.3s ease-out;
    }

    .interim-text {
        color: #666;
        opacity: 0.8;
        border-bottom: 1px dotted #aaa;
        transition: all 0.2s;
    }

    /* ‚úÖ TEXTO FINALIZADO */
    .final-text {
        color: inherit;
        opacity: 1;
        animation: textFinalized 0.3s ease-out;
    }

    /* üéöÔ∏è ANIMA√á√ïES */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(2px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes textFinalized {
        from { opacity: 0.5; }
        to { opacity: 1; }
    }

    /* üì± RESPONSIVIDADE */
    @media (max-width: 768px) {
        .phrase-box {
            font-size: 14px;
            line-height: 1.3;
        }
    }
  </style>
</head>
<body>
  <!-- üîµ BOX AZUL PARA VOZ-PARA-TEXTO -->
  <div class="chat-input-box" id="textDisplay"></div>

  <div class="container">
    <div class="video-wrapper">
      <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div class="video-wrapper">
      <video id="localVideo" autoplay muted playsinline></video>
    </div>

    <div class="info-overlay">
      <div id="qrcode" class="qrcode-container"></div>
    </div>
  </div>

  <script src="https://lemur-signal.onrender.com/socket.io/socket.io.js"></script>
  <script type="module">
    // --- C√ìDIGO ORIGINAL DO RECEIVER (100% PRESERVADO) ---
    import WebRTCCore from '../core/webrtc-core.js';
    import { QRCodeGenerator } from './qr-code-utils.js';

    window.onload = () => {
      const rtcCore = new WebRTCCore();
      const myId = crypto.randomUUID().substr(0, 8);
      let localStream = null;

      // Solicita acesso √† c√¢mera
      navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then(stream => {
          localStream = stream;
        })
        .catch(error => {
          console.error("Erro ao acessar a c√¢mera:", error);
        });

      // Gera QR Code com link para caller
      const callerUrl = `${window.location.origin}/caller.html?targetId=${myId}`;
      QRCodeGenerator.generate("qrcode", callerUrl);

      rtcCore.initialize(myId);
      rtcCore.setupSocketHandlers();

      const localVideo = document.getElementById('localVideo');

      rtcCore.onIncomingCall = (offer) => {
        if (!localStream) {
          console.warn("Stream local n√£o dispon√≠vel");
          return;
        }

        rtcCore.handleIncomingCall(offer, localStream, (remoteStream) => {
          // üîá Silencia √°udio recebido (ORIGINAL)
          remoteStream.getAudioTracks().forEach(track => track.enabled = false);

          // üî• Oculta o QR Code (ORIGINAL)
          const qrElement = document.getElementById('qrcode');
          if (qrElement) qrElement.style.display = 'none';

          // Exibe v√≠deo remoto no PIP (ORIGINAL)
          localVideo.srcObject = remoteStream;
        });
      };

      // --- SISTEMA DE VOZ-PARA-TEXTO (ADICIONADO) ---
      const chatInputBox = document.querySelector('.chat-input-box');
      
      // 1. Configura√ß√£o do chat (box azul)
      const textDisplay = document.createElement('div');
      textDisplay.className = 'text-display-placeholder';
      textDisplay.style.padding = '10px';
      textDisplay.style.color = 'black';
      textDisplay.style.textAlign = 'center';
      textDisplay.style.height = '100%';
      textDisplay.style.display = 'flex';
      textDisplay.style.alignItems = 'center';
      textDisplay.style.justifyContent = 'center';
      textDisplay.style.wordBreak = 'break-word';
      textDisplay.style.overflowY = 'auto';
      chatInputBox.appendChild(textDisplay);

      // 2. Cria√ß√£o do container dos controles
      const langControls = document.createElement('div');
      langControls.style.position = 'fixed';
      langControls.style.bottom = '80px';
      langControls.style.left = '50%';
      langControls.style.transform = 'translateX(-50%)';
      langControls.style.marginLeft = '-70px';
      langControls.style.zIndex = '100';
      langControls.style.display = 'flex';
      langControls.style.alignItems = 'center';
      langControls.style.gap = '10px';
      document.body.appendChild(langControls);

      // 3. Bal√£o do idioma detectado
      const detectedLangBubble = document.createElement('div');
      detectedLangBubble.className = 'lang-bubble';
      detectedLangBubble.style.display = 'flex';
      detectedLangBubble.style.alignItems = 'center';
      detectedLangBubble.style.justifyContent = 'center';
      detectedLangBubble.style.width = '50px';
      detectedLangBubble.style.height = '50px';
      detectedLangBubble.style.backgroundColor = 'white';
      detectedLangBubble.style.borderRadius = '50%';
      detectedLangBubble.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
      detectedLangBubble.style.cursor = 'pointer';
      detectedLangBubble.style.fontSize = '24px';
      langControls.appendChild(detectedLangBubble);

      // 4. Bot√£o de sele√ß√£o de idiomas (üåê)
      const langSelectButton = document.createElement('button');
      langSelectButton.className = 'lang-select-btn';
      langSelectButton.textContent = 'üåê';
      langSelectButton.title = 'Selecionar idioma';
      langSelectButton.style.display = 'flex';
      langSelectButton.style.alignItems = 'center';
      langSelectButton.style.justifyContent = 'center';
      langSelectButton.style.width = '50px';
      langSelectButton.style.height = '50px';
      langSelectButton.style.backgroundColor = 'white';
      langSelectButton.style.borderRadius = '50%';
      langSelectButton.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
      langSelectButton.style.border = 'none';
      langSelectButton.style.cursor = 'pointer';
      langSelectButton.style.fontSize = '24px';
      langControls.appendChild(langSelectButton);

      // 5. Menu de idiomas
      const languageMenu = document.createElement('div');
      languageMenu.className = 'language-menu';
      languageMenu.style.display = 'none';
      languageMenu.style.position = 'absolute';
      languageMenu.style.backgroundColor = 'white';
      languageMenu.style.borderRadius = '8px';
      languageMenu.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
      languageMenu.style.padding = '10px';
      languageMenu.style.zIndex = '1000';
      languageMenu.style.minWidth = '60px';
      document.body.appendChild(languageMenu);

      // 6. Idiomas dispon√≠veis
      const languages = [
        { code: 'en-US', flag: 'üá∫üá∏', speakText: 'Speak now', name: 'English' },
        { code: 'pt-BR', flag: 'üáßüá∑', speakText: 'Fale agora', name: 'Portugu√™s' },
        { code: 'es-ES', flag: 'üá™üá∏', speakText: 'Habla agora', name: 'Espa√±ol' },
        { code: 'fr-FR', flag: 'üá´üá∑', speakText: 'Parlez maintenant', name: 'Fran√ßais' },
        { code: 'de-DE', flag: 'üá©üá™', speakText: 'Sprechen Sie jetzt', name: 'Deutsch' },
        { code: 'ja-JP', flag: 'üáØüáµ', speakText: 'Ë©±„Åó„Å¶„Åè„Å†„Åï„ÅÑ', name: 'Êó•Êú¨Ë™û' },
        { code: 'zh-CN', flag: 'üá®üá≥', speakText: 'Áé∞Âú®ËØ¥ËØù', name: '‰∏≠Êñá' },
        { code: 'ru-RU', flag: 'üá∑üá∫', speakText: '–ì–æ–≤–æ—Ä–∏—Ç–µ —Å–µ–π—á–∞—Å', name: '–†—É—Å—Å–∫–∏–π' },
        { code: 'ar-SA', flag: 'üá∏üá¶', speakText: 'ÿ™ÿ≠ÿØÿ´ ÿßŸÑÿ¢ŸÜ', name: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©' }
      ];

      // 7. L√≥gica de detec√ß√£o de idioma
      const browserLanguage = navigator.language;
      let currentLang = languages.find(lang => browserLanguage.startsWith(lang.code.split('-')[0])) || languages[0];
      detectedLangBubble.textContent = currentLang.flag;
      detectedLangBubble.title = `Idioma atual: ${currentLang.name}`;

      // 8. Popula o menu de idiomas
      languages.forEach(lang => {
        const langBtn = document.createElement('button');
        langBtn.className = 'lang-option';
        langBtn.innerHTML = `${lang.flag}`;
        langBtn.dataset.langCode = lang.code;
        langBtn.dataset.speakText = lang.speakText;
        langBtn.title = lang.name;
        langBtn.style.display = 'block';
        langBtn.style.width = '100%';
        langBtn.style.padding = '8px 12px';
        langBtn.style.textAlign = 'center';
        langBtn.style.border = 'none';
        langBtn.style.background = 'none';
        langBtn.style.cursor = 'pointer';
        langBtn.style.borderRadius = '4px';
        langBtn.style.margin = '2px 0';
        langBtn.style.fontSize = '24px';
        langBtn.addEventListener('mouseover', () => {
          langBtn.style.backgroundColor = '#f0f0f0';
        });
        langBtn.addEventListener('mouseout', () => {
          langBtn.style.backgroundColor = 'transparent';
        });
        languageMenu.appendChild(langBtn);
      });

      // 9. Controle do menu
      langSelectButton.addEventListener('click', (e) => {
        e.stopPropagation();
        const rect = langSelectButton.getBoundingClientRect();
        languageMenu.style.display = 'block';
        languageMenu.style.top = `${rect.top - languageMenu.offsetHeight - 10}px`;
        languageMenu.style.left = `${rect.left}px`;
      });

      document.addEventListener('click', () => {
        languageMenu.style.display = 'none';
      });

      // 10. Configura√ß√£o do reconhecimento de voz
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      let recognition = null;
      let isListening = false;

      if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = currentLang.code;

        // Mensagem inicial no idioma correto
        textDisplay.textContent = `${getClickToSpeakMessage(currentLang.code)}`;

        // Clique na bandeira ativa/desativa o microfone
        detectedLangBubble.addEventListener('click', () => {
          if (!isListening) {
            try {
              recognition.start();
              textDisplay.textContent = `${currentLang.speakText}...`;
              textDisplay.style.display = 'flex';
              isListening = true;
            } catch (e) {
              console.error('Erro ao iniciar microfone:', e);
              textDisplay.textContent = `${getErrorMessage(currentLang.code)}`;
              textDisplay.style.display = 'flex';
            }
          } else {
            recognition.stop();
            textDisplay.textContent = `${getMicOffMessage(currentLang.code)}`;
            textDisplay.style.display = 'flex';
            isListening = false;
          }
        });

        // Menu de idiomas
        languageMenu.addEventListener('click', (e) => {
          if (e.target.classList.contains('lang-option')) {
            const langCode = e.target.dataset.langCode;
            const flag = e.target.textContent;
            const langName = e.target.title;

            document.querySelectorAll('.phrase-box').forEach(el => el.remove());
            textDisplay.style.display = 'flex';
            textDisplay.textContent = getClickToSpeakMessage(langCode);

            currentLang = languages.find(l => l.code === langCode);
            detectedLangBubble.textContent = currentLang.flag;
            detectedLangBubble.title = `Idioma atual: ${currentLang.name}`;

            if (isListening) {
              recognition.stop();
              isListening = false;
            }

            recognition.lang = langCode;
            languageMenu.style.display = 'none';
          }
        });

        recognition.onresult = (event) => {
          if (textDisplay.classList.contains('text-display-placeholder')) {
            textDisplay.style.display = 'none';
          }

          let finalTranscript = '';
          let interimTranscript = '';

          for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
              finalTranscript += transcript;
            } else {
              interimTranscript += transcript;
            }
          }

          const chatInputBox = document.querySelector('.chat-input-box');
          
          if (finalTranscript.trim()) {
            const interimBox = document.querySelector('.interim-box');
            if (interimBox) interimBox.remove();
            
            const phraseBox = document.createElement('div');
            phraseBox.className = 'phrase-box';
            phraseBox.textContent = finalTranscript;
            
            if (chatInputBox) {
              chatInputBox.appendChild(phraseBox);
              chatInputBox.scrollTop = chatInputBox.scrollHeight;
              textDisplay.textContent = `${currentLang.speakText}...`;
            }
          }
          else if (interimTranscript) {
            let interimBox = document.querySelector('.interim-box');
            
            if (!interimBox) {
              interimBox = document.createElement('div');
              interimBox.className = 'interim-box';
              if (chatInputBox) chatInputBox.appendChild(interimBox);
            }
            
            interimBox.textContent = interimTranscript;
            if (chatInputBox) chatInputBox.scrollTop = chatInputBox.scrollHeight;
          }
        };

        recognition.onerror = (event) => {
          console.error('Erro no reconhecimento:', event.error);
          textDisplay.textContent = `${getErrorMessage(currentLang.code)}`;
          textDisplay.style.display = 'flex';
          isListening = false;
        };

        recognition.onend = () => {
          if (!document.querySelector('.phrase-box')) {
            textDisplay.style.display = 'flex';
          }

          if (isListening) {
            setTimeout(() => {
              try {
                recognition.start();
              } catch (e) {
                console.error('Erro ao reiniciar:', e);
                isListening = false;
                textDisplay.textContent = `${getErrorMessage(currentLang.code)}`;
                textDisplay.style.display = 'flex';
              }
            }, 300);
          }
        };
      } else {
        textDisplay.textContent = 'Seu navegador n√£o suporta reconhecimento de voz';
        textDisplay.style.color = 'black';
        console.error('API de reconhecimento de voz n√£o suportada');
      }

      // Fun√ß√µes auxiliares para mensagens
      function getClickToSpeakMessage(langCode) {
        const messages = {
          'en-US': 'Click flag to speak',
          'pt-BR': 'Clique na bandeira para falar',
          'es-ES': 'Haz clic en la bandera para hablar',
          'fr-FR': 'Cliquez sur le drapeau pour parler',
          'de-DE': 'Klicken Sie auf die Flagge zum Sprechen',
          'ja-JP': 'Êóó„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Ë©±„Åô',
          'zh-CN': 'ÁÇπÂáªÊóóÂ∏úËØ¥ËØù',
          'ru-RU': '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ñ–ª–∞–≥, —á—Ç–æ–±—ã –≥–æ–≤–æ—Ä–∏—Ç—å',
          'ar-SA': 'ÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿßŸÑÿπŸÑŸÖ ŸÑŸÑÿ™ÿ≠ÿØÿ´'
        };
        return messages[langCode] || messages['en-US'];
      }

      function getMicOffMessage(langCode) {
        const messages = {
          'en-US': 'Microphone off',
          'pt-BR': 'Microfone desativado',
          'es-ES': 'Micr√≥fono desactivado',
          'fr-FR': 'Microphone d√©sactiv√©',
          'de-DE': 'Mikrofon ausgeschaltet',
          'ja-JP': '„Éû„Ç§„ÇØ„Ç™„Éï',
          'zh-CN': 'È∫¶ÂÖãÈ£éÂÖ≥Èó≠',
          'ru-RU': '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω',
          'ar-SA': 'ÿ™ŸÖ ÿ•ŸäŸÇÿßŸÅ ÿßŸÑŸÖŸäŸÉÿ±ŸàŸÅŸàŸÜ'
        };
        return messages[langCode] || messages['en-US'];
      }

      function getErrorMessage(langCode) {
        const messages = {
          'en-US': 'Microphone error',
          'pt-BR': 'Erro no microfone',
          'es-ES': 'Error de micr√≥fono',
          'fr-FR': 'Erreur de microphone',
          'de-DE': 'Mikrofonfehler',
          'ja-JP': '„Éû„Ç§„ÇØ„Ç®„É©„Éº',
          'zh-CN': 'È∫¶ÂÖãÈ£éÈîôËØØ',
          'ru-RU': '–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞',
          'ar-SA': 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÖŸäŸÉÿ±ŸàŸÅŸàŸÜ'
        };
        return messages[langCode] || messages['en-US'];
      }
    };
  </script>
</body>
</html>
