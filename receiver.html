<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lemur Translator</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="responsivo.css" />
  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
</head>
<body>
  <!-- ==== TELA INICIAL ==== -->
  <div id="page1">
    <img src="assets/images/solemur.png" alt="Lemur Logo" class="logo" id="logo">
    <h1 id="welcome-title">Welcome!</h1>
    <div class="translator-label" id="translator-label">Real-Time Translator</div>
    <input type="text" class="name-input" id="name-input" placeholder="Type your name">
    <button class="next-button" id="next-button">Next</button>
  </div>

  <!-- ==== TELA VERDE (RECEIVER) ==== -->
  <div class="welcome-screen" id="welcome-screen">
    <div class="welcome-message" id="welcome-message">Welcome</div>
    <div class="user-name" id="user-name-display"></div>
    <p id="chat-description">Starting real-time translation</p>
    <button class="continue-button" id="continue-button">Continue to Video Call</button>
  </div>

  <!-- ==== TELA DE VÍDEO CRUZADO ==== -->
  <div class="container" id="page3">
    <div class="video-wrapper">
      <video id="remoteVideo" autoplay playsinline></video>
    </div>
    <div class="info-overlay">
      <div id="qrcode" class="qrcode-container"></div>
    </div>
  </div>

  <script>
    const TRANSLATE_ENDPOINT = 'https://chat-tradutor.onrender.com/translate';

    const textsToTranslate = {
      "welcome-title": "Welcome!",
      "translator-label": "Real-Time Translator",
      "name-input": "Type your name",
      "next-button": "Next",
      "welcome-message": "Welcome",
      "chat-description": "Starting real-time translation",
      "continue-button": "Continue to Video Call"
    };

    async function translateText(text, targetLang) {
      try {
        if (targetLang === 'en') return text;
        const response = await fetch(TRANSLATE_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text, targetLang })
        });
        const result = await response.json();
        return result.translatedText || text;
      } catch (error) {
        console.error('Erro na tradução:', error);
        return text;
      }
    }

    async function translatePage() {
      const browserLang = (navigator.language || 'en').split('-')[0];
      for (const [elementId, text] of Object.entries(textsToTranslate)) {
        try {
          const translated = await translateText(text, browserLang);
          const element = document.getElementById(elementId);
          if (element) {
            if (elementId === 'name-input') {
              element.placeholder = translated;
            } else {
              element.textContent = translated;
            }
          }
        } catch (error) {
          console.error(`Erro ao traduzir ${elementId}:`, error);
        }
      }
    }

    function generateSessionId() {
      return 'session-' + Math.random().toString(36).substr(2, 9);
    }

    function generateQRCode() {
      document.getElementById('qrcode').innerHTML = '';
      const sessionId = generateSessionId();
      new QRCode(document.getElementById('qrcode'), {
        text: `https://lemur-interface-traducao.netlify.app/caller.html?session=${sessionId}`,
        width: 150,
        height: 150,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
      startReceiverConnection(sessionId);
    }

    function startReceiverConnection(sessionId) {
      const socket = io('https://lemur-signal.onrender.com');
      let peerConnection;

      async function setupWebRTC() {
        peerConnection = new RTCPeerConnection({
          iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        });

        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: false
          });
          stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));
        } catch (error) {
          console.error('Erro ao acessar câmera:', error);
        }

        socket.on('offer', async (offer) => {
          try {
            await peerConnection.setRemoteDescription(offer);
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit('answer', answer, sessionId);
          } catch (error) {
            console.error('Erro no tratamento da oferta:', error);
          }
        });

        peerConnection.ontrack = (event) => {
          document.getElementById('remoteVideo').srcObject = event.streams[0];
        };

        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            socket.emit('ice-candidate', event.candidate, sessionId);
          }
        };

        socket.on('ice-candidate', (candidate) => {
          peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
            .catch(e => console.error('Erro ao adicionar ICE candidate:', e));
        });

        socket.on('connect', () => {
          console.log('Conectado ao servidor de sinalização');
          socket.emit('join-receiver', sessionId);
        });

        socket.on('disconnect', () => {
          console.log('Desconectado do servidor de sinalização');
        });
      }

      setupWebRTC();
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await translatePage();

      document.getElementById('next-button').addEventListener('click', function () {
        const nameInput = document.getElementById('name-input');
        const name = nameInput.value.trim();
        if (!name) {
          document.body.classList.add('error-state');
          setTimeout(() => {
            document.body.classList.remove('error-state');
          }, 1000);
          return;
        }
        document.getElementById('page1').style.display = 'none';
        document.getElementById('user-name-display').textContent = name;
        document.getElementById('welcome-screen').style.display = 'flex';
      });

      document.getElementById('continue-button').addEventListener('click', function () {
        document.getElementById('welcome-screen').style.display = 'none';
        document.getElementById('page3').style.display = 'block';
        generateQRCode();
      });
    });
  </script>

  <script src="https://lemur-signal.onrender.com/socket.io/socket.io.js"></script>
</body>
</html>
